{"ast":null,"code":"import _regeneratorRuntime from\"/projects/testswap/uniswap-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/projects/testswap/uniswap-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/projects/testswap/uniswap-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _taggedTemplateLiteral from\"/projects/testswap/uniswap-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral\";function _templateObject2(){var data=_taggedTemplateLiteral([\"\\n  width: 100%;\\n  padding: 1rem;\\n\"]);_templateObject2=function _templateObject2(){return data;};return data;}function _templateObject(){var data=_taggedTemplateLiteral([\"\\n  display: flex;\\n  justify-content: space-between;\\n  padding-right: 20px;\\n  padding-left: 20px;\\n\\n  opacity: \",\";\\n\"]);_templateObject=function _templateObject(){return data;};return data;}import React,{useState,useCallback}from'react';import useIsArgentWallet from'../../hooks/useIsArgentWallet';import useTransactionDeadline from'../../hooks/useTransactionDeadline';import Modal from'../Modal';import{AutoColumn}from'../Column';import styled from'styled-components';import{RowBetween}from'../Row';import{TYPE,CloseIcon}from'../../theme';import{ButtonConfirmed,ButtonError}from'../Button';import ProgressCircles from'../ProgressSteps';import CurrencyInputPanel from'../CurrencyInputPanel';import{TokenAmount,Pair}from'@uniswap/sdk';import{useActiveWeb3React}from'../../hooks';import{maxAmountSpend}from'../../utils/maxAmountSpend';import{usePairContract,useStakingContract}from'../../hooks/useContract';import{useApproveCallback,ApprovalState}from'../../hooks/useApproveCallback';import{splitSignature}from'ethers/lib/utils';import{useDerivedStakeInfo}from'../../state/stake/hooks';import{wrappedCurrencyAmount}from'../../utils/wrappedCurrency';import{useTransactionAdder}from'../../state/transactions/hooks';import{LoadingView,SubmittedView}from'../ModalViews';var HypotheticalRewardRate=styled.div(_templateObject(),function(_ref){var dim=_ref.dim;return dim?0.5:1;});var ContentWrapper=styled(AutoColumn)(_templateObject2());export default function StakingModal(_ref2){var isOpen=_ref2.isOpen,onDismiss=_ref2.onDismiss,stakingInfo=_ref2.stakingInfo,userLiquidityUnstaked=_ref2.userLiquidityUnstaked;var _useActiveWeb3React=useActiveWeb3React(),account=_useActiveWeb3React.account,chainId=_useActiveWeb3React.chainId,library=_useActiveWeb3React.library;// track and parse user input\nvar _useState=useState(''),_useState2=_slicedToArray(_useState,2),typedValue=_useState2[0],setTypedValue=_useState2[1];var _useDerivedStakeInfo=useDerivedStakeInfo(typedValue,stakingInfo.stakedAmount.token,userLiquidityUnstaked),parsedAmount=_useDerivedStakeInfo.parsedAmount,error=_useDerivedStakeInfo.error;var parsedAmountWrapped=wrappedCurrencyAmount(parsedAmount,chainId);var hypotheticalRewardRate=new TokenAmount(stakingInfo.rewardRate.token,'0');if(parsedAmountWrapped===null||parsedAmountWrapped===void 0?void 0:parsedAmountWrapped.greaterThan('0')){hypotheticalRewardRate=stakingInfo.getHypotheticalRewardRate(stakingInfo.stakedAmount.add(parsedAmountWrapped),stakingInfo.totalStakedAmount.add(parsedAmountWrapped),stakingInfo.totalRewardRate);}// state for pending and submitted txn views\nvar addTransaction=useTransactionAdder();var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),attempting=_useState4[0],setAttempting=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),hash=_useState6[0],setHash=_useState6[1];var wrappedOnDismiss=useCallback(function(){setHash(undefined);setAttempting(false);onDismiss();},[onDismiss]);// pair contract for this token to be staked\nvar dummyPair=new Pair(new TokenAmount(stakingInfo.tokens[0],'0'),new TokenAmount(stakingInfo.tokens[1],'0'));var pairContract=usePairContract(dummyPair.liquidityToken.address);// approval data for stake\nvar deadline=useTransactionDeadline();var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),signatureData=_useState8[0],setSignatureData=_useState8[1];var _useApproveCallback=useApproveCallback(parsedAmount,stakingInfo.stakingRewardAddress),_useApproveCallback2=_slicedToArray(_useApproveCallback,2),approval=_useApproveCallback2[0],approveCallback=_useApproveCallback2[1];var isArgentWallet=useIsArgentWallet();var stakingContract=useStakingContract(stakingInfo.stakingRewardAddress);function onStake(){return _onStake.apply(this,arguments);}// wrapped onUserInput to clear signatures\nfunction _onStake(){_onStake=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setAttempting(true);if(!(stakingContract&&parsedAmount&&deadline)){_context.next=13;break;}if(!(approval===ApprovalState.APPROVED)){_context.next=7;break;}_context.next=5;return stakingContract.stake(\"0x\".concat(parsedAmount.raw.toString(16)),{gasLimit:350000});case 5:_context.next=13;break;case 7:if(!signatureData){_context.next=11;break;}stakingContract.stakeWithPermit(\"0x\".concat(parsedAmount.raw.toString(16)),signatureData.deadline,signatureData.v,signatureData.r,signatureData.s,{gasLimit:350000}).then(function(response){addTransaction(response,{summary:\"Deposit liquidity\"});setHash(response.hash);}).catch(function(error){setAttempting(false);console.log(error);});_context.next=13;break;case 11:setAttempting(false);throw new Error('Attempting to stake without approval or a signature. Please contact support.');case 13:case\"end\":return _context.stop();}}},_callee);}));return _onStake.apply(this,arguments);}var onUserInput=useCallback(function(typedValue){setSignatureData(null);setTypedValue(typedValue);},[]);// used for max input button\nvar maxAmountInput=maxAmountSpend(userLiquidityUnstaked);var atMaxAmount=Boolean(maxAmountInput&&(parsedAmount===null||parsedAmount===void 0?void 0:parsedAmount.equalTo(maxAmountInput)));var handleMax=useCallback(function(){maxAmountInput&&onUserInput(maxAmountInput.toExact());},[maxAmountInput,onUserInput]);function onAttemptToApprove(){return _onAttemptToApprove.apply(this,arguments);}function _onAttemptToApprove(){_onAttemptToApprove=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var liquidityAmount,nonce,EIP712Domain,domain,Permit,message,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(!pairContract||!library||!deadline)){_context2.next=2;break;}throw new Error('missing dependencies');case 2:liquidityAmount=parsedAmount;if(liquidityAmount){_context2.next=5;break;}throw new Error('missing liquidity amount');case 5:if(!isArgentWallet){_context2.next=7;break;}return _context2.abrupt(\"return\",approveCallback());case 7:_context2.next=9;return pairContract.nonces(account);case 9:nonce=_context2.sent;EIP712Domain=[{name:'name',type:'string'},{name:'version',type:'string'},{name:'chainId',type:'uint256'},{name:'verifyingContract',type:'address'}];domain={name:'Uniswap V2',version:'1',chainId:chainId,verifyingContract:pairContract.address};Permit=[{name:'owner',type:'address'},{name:'spender',type:'address'},{name:'value',type:'uint256'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'}];message={owner:account,spender:stakingInfo.stakingRewardAddress,value:liquidityAmount.raw.toString(),nonce:nonce.toHexString(),deadline:deadline.toNumber()};data=JSON.stringify({types:{EIP712Domain:EIP712Domain,Permit:Permit},domain:domain,primaryType:'Permit',message:message});library.send('eth_signTypedData_v4',[account,data]).then(splitSignature).then(function(signature){setSignatureData({v:signature.v,r:signature.r,s:signature.s,deadline:deadline.toNumber()});}).catch(function(error){// for all errors other than 4001 (EIP-1193 user rejected request), fall back to manual approve\nif((error===null||error===void 0?void 0:error.code)!==4001){approveCallback();}});case 16:case\"end\":return _context2.stop();}}},_callee2);}));return _onAttemptToApprove.apply(this,arguments);}return/*#__PURE__*/React.createElement(Modal,{isOpen:isOpen,onDismiss:wrappedOnDismiss,maxHeight:90},!attempting&&!hash&&/*#__PURE__*/React.createElement(ContentWrapper,{gap:\"lg\"},/*#__PURE__*/React.createElement(RowBetween,null,/*#__PURE__*/React.createElement(TYPE.mediumHeader,null,\"Deposit\"),/*#__PURE__*/React.createElement(CloseIcon,{onClick:wrappedOnDismiss})),/*#__PURE__*/React.createElement(CurrencyInputPanel,{value:typedValue,onUserInput:onUserInput,onMax:handleMax,showMaxButton:!atMaxAmount,currency:stakingInfo.stakedAmount.token,pair:dummyPair,label:'',disableCurrencySelect:true,customBalanceText:'Available to deposit: ',id:\"stake-liquidity-token\"}),/*#__PURE__*/React.createElement(HypotheticalRewardRate,{dim:!hypotheticalRewardRate.greaterThan('0')},/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(TYPE.black,{fontWeight:600},\"Weekly Rewards\")),/*#__PURE__*/React.createElement(TYPE.black,null,hypotheticalRewardRate.multiply((60*60*24*7).toString()).toSignificant(4,{groupSeparator:','}),' ',\"UNI / week\")),/*#__PURE__*/React.createElement(RowBetween,null,/*#__PURE__*/React.createElement(ButtonConfirmed,{mr:\"0.5rem\",onClick:onAttemptToApprove,confirmed:approval===ApprovalState.APPROVED||signatureData!==null,disabled:approval!==ApprovalState.NOT_APPROVED||signatureData!==null},\"Approve\"),/*#__PURE__*/React.createElement(ButtonError,{disabled:!!error||signatureData===null&&approval!==ApprovalState.APPROVED,error:!!error&&!!parsedAmount,onClick:onStake},error!==null&&error!==void 0?error:'Deposit')),/*#__PURE__*/React.createElement(ProgressCircles,{steps:[approval===ApprovalState.APPROVED||signatureData!==null],disabled:true})),attempting&&!hash&&/*#__PURE__*/React.createElement(LoadingView,{onDismiss:wrappedOnDismiss},/*#__PURE__*/React.createElement(AutoColumn,{gap:\"12px\",justify:'center'},/*#__PURE__*/React.createElement(TYPE.largeHeader,null,\"Depositing Liquidity\"),/*#__PURE__*/React.createElement(TYPE.body,{fontSize:20},parsedAmount===null||parsedAmount===void 0?void 0:parsedAmount.toSignificant(4),\" UNI-V2\"))),attempting&&hash&&/*#__PURE__*/React.createElement(SubmittedView,{onDismiss:wrappedOnDismiss,hash:hash},/*#__PURE__*/React.createElement(AutoColumn,{gap:\"12px\",justify:'center'},/*#__PURE__*/React.createElement(TYPE.largeHeader,null,\"Transaction Submitted\"),/*#__PURE__*/React.createElement(TYPE.body,{fontSize:20},\"Deposited \",parsedAmount===null||parsedAmount===void 0?void 0:parsedAmount.toSignificant(4),\" UNI-V2\"))));}","map":{"version":3,"sources":["/projects/testswap/uniswap-interface/src/components/earn/StakingModal.tsx"],"names":["React","useState","useCallback","useIsArgentWallet","useTransactionDeadline","Modal","AutoColumn","styled","RowBetween","TYPE","CloseIcon","ButtonConfirmed","ButtonError","ProgressCircles","CurrencyInputPanel","TokenAmount","Pair","useActiveWeb3React","maxAmountSpend","usePairContract","useStakingContract","useApproveCallback","ApprovalState","splitSignature","useDerivedStakeInfo","wrappedCurrencyAmount","useTransactionAdder","LoadingView","SubmittedView","HypotheticalRewardRate","div","dim","ContentWrapper","StakingModal","isOpen","onDismiss","stakingInfo","userLiquidityUnstaked","account","chainId","library","typedValue","setTypedValue","stakedAmount","token","parsedAmount","error","parsedAmountWrapped","hypotheticalRewardRate","rewardRate","greaterThan","getHypotheticalRewardRate","add","totalStakedAmount","totalRewardRate","addTransaction","attempting","setAttempting","hash","setHash","wrappedOnDismiss","undefined","dummyPair","tokens","pairContract","liquidityToken","address","deadline","signatureData","setSignatureData","stakingRewardAddress","approval","approveCallback","isArgentWallet","stakingContract","onStake","APPROVED","stake","raw","toString","gasLimit","stakeWithPermit","v","r","s","then","response","summary","catch","console","log","Error","onUserInput","maxAmountInput","atMaxAmount","Boolean","equalTo","handleMax","toExact","onAttemptToApprove","liquidityAmount","nonces","nonce","EIP712Domain","name","type","domain","version","verifyingContract","Permit","message","owner","spender","value","toHexString","toNumber","data","JSON","stringify","types","primaryType","send","signature","code","multiply","toSignificant","groupSeparator","NOT_APPROVED"],"mappings":"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","sourcesContent":["import React, { useState, useCallback } from 'react'\nimport useIsArgentWallet from '../../hooks/useIsArgentWallet'\nimport useTransactionDeadline from '../../hooks/useTransactionDeadline'\nimport Modal from '../Modal'\nimport { AutoColumn } from '../Column'\nimport styled from 'styled-components'\nimport { RowBetween } from '../Row'\nimport { TYPE, CloseIcon } from '../../theme'\nimport { ButtonConfirmed, ButtonError } from '../Button'\nimport ProgressCircles from '../ProgressSteps'\nimport CurrencyInputPanel from '../CurrencyInputPanel'\nimport { TokenAmount, Pair } from '@uniswap/sdk'\nimport { useActiveWeb3React } from '../../hooks'\nimport { maxAmountSpend } from '../../utils/maxAmountSpend'\nimport { usePairContract, useStakingContract } from '../../hooks/useContract'\nimport { useApproveCallback, ApprovalState } from '../../hooks/useApproveCallback'\nimport { splitSignature } from 'ethers/lib/utils'\nimport { StakingInfo, useDerivedStakeInfo } from '../../state/stake/hooks'\nimport { wrappedCurrencyAmount } from '../../utils/wrappedCurrency'\nimport { TransactionResponse } from '@ethersproject/providers'\nimport { useTransactionAdder } from '../../state/transactions/hooks'\nimport { LoadingView, SubmittedView } from '../ModalViews'\n\nconst HypotheticalRewardRate = styled.div<{ dim: boolean }>`\n  display: flex;\n  justify-content: space-between;\n  padding-right: 20px;\n  padding-left: 20px;\n\n  opacity: ${({ dim }) => (dim ? 0.5 : 1)};\n`\n\nconst ContentWrapper = styled(AutoColumn)`\n  width: 100%;\n  padding: 1rem;\n`\n\ninterface StakingModalProps {\n  isOpen: boolean\n  onDismiss: () => void\n  stakingInfo: StakingInfo\n  userLiquidityUnstaked: TokenAmount | undefined\n}\n\nexport default function StakingModal({ isOpen, onDismiss, stakingInfo, userLiquidityUnstaked }: StakingModalProps) {\n  const { account, chainId, library } = useActiveWeb3React()\n\n  // track and parse user input\n  const [typedValue, setTypedValue] = useState('')\n  const { parsedAmount, error } = useDerivedStakeInfo(typedValue, stakingInfo.stakedAmount.token, userLiquidityUnstaked)\n  const parsedAmountWrapped = wrappedCurrencyAmount(parsedAmount, chainId)\n\n  let hypotheticalRewardRate: TokenAmount = new TokenAmount(stakingInfo.rewardRate.token, '0')\n  if (parsedAmountWrapped?.greaterThan('0')) {\n    hypotheticalRewardRate = stakingInfo.getHypotheticalRewardRate(\n      stakingInfo.stakedAmount.add(parsedAmountWrapped),\n      stakingInfo.totalStakedAmount.add(parsedAmountWrapped),\n      stakingInfo.totalRewardRate\n    )\n  }\n\n  // state for pending and submitted txn views\n  const addTransaction = useTransactionAdder()\n  const [attempting, setAttempting] = useState<boolean>(false)\n  const [hash, setHash] = useState<string | undefined>()\n  const wrappedOnDismiss = useCallback(() => {\n    setHash(undefined)\n    setAttempting(false)\n    onDismiss()\n  }, [onDismiss])\n\n  // pair contract for this token to be staked\n  const dummyPair = new Pair(new TokenAmount(stakingInfo.tokens[0], '0'), new TokenAmount(stakingInfo.tokens[1], '0'))\n  const pairContract = usePairContract(dummyPair.liquidityToken.address)\n\n  // approval data for stake\n  const deadline = useTransactionDeadline()\n  const [signatureData, setSignatureData] = useState<{ v: number; r: string; s: string; deadline: number } | null>(null)\n  const [approval, approveCallback] = useApproveCallback(parsedAmount, stakingInfo.stakingRewardAddress)\n\n  const isArgentWallet = useIsArgentWallet()\n  const stakingContract = useStakingContract(stakingInfo.stakingRewardAddress)\n  async function onStake() {\n    setAttempting(true)\n    if (stakingContract && parsedAmount && deadline) {\n      if (approval === ApprovalState.APPROVED) {\n        await stakingContract.stake(`0x${parsedAmount.raw.toString(16)}`, { gasLimit: 350000 })\n      } else if (signatureData) {\n        stakingContract\n          .stakeWithPermit(\n            `0x${parsedAmount.raw.toString(16)}`,\n            signatureData.deadline,\n            signatureData.v,\n            signatureData.r,\n            signatureData.s,\n            { gasLimit: 350000 }\n          )\n          .then((response: TransactionResponse) => {\n            addTransaction(response, {\n              summary: `Deposit liquidity`\n            })\n            setHash(response.hash)\n          })\n          .catch((error: any) => {\n            setAttempting(false)\n            console.log(error)\n          })\n      } else {\n        setAttempting(false)\n        throw new Error('Attempting to stake without approval or a signature. Please contact support.')\n      }\n    }\n  }\n\n  // wrapped onUserInput to clear signatures\n  const onUserInput = useCallback((typedValue: string) => {\n    setSignatureData(null)\n    setTypedValue(typedValue)\n  }, [])\n\n  // used for max input button\n  const maxAmountInput = maxAmountSpend(userLiquidityUnstaked)\n  const atMaxAmount = Boolean(maxAmountInput && parsedAmount?.equalTo(maxAmountInput))\n  const handleMax = useCallback(() => {\n    maxAmountInput && onUserInput(maxAmountInput.toExact())\n  }, [maxAmountInput, onUserInput])\n\n  async function onAttemptToApprove() {\n    if (!pairContract || !library || !deadline) throw new Error('missing dependencies')\n    const liquidityAmount = parsedAmount\n    if (!liquidityAmount) throw new Error('missing liquidity amount')\n\n    if (isArgentWallet) {\n      return approveCallback()\n    }\n\n    // try to gather a signature for permission\n    const nonce = await pairContract.nonces(account)\n\n    const EIP712Domain = [\n      { name: 'name', type: 'string' },\n      { name: 'version', type: 'string' },\n      { name: 'chainId', type: 'uint256' },\n      { name: 'verifyingContract', type: 'address' }\n    ]\n    const domain = {\n      name: 'Uniswap V2',\n      version: '1',\n      chainId: chainId,\n      verifyingContract: pairContract.address\n    }\n    const Permit = [\n      { name: 'owner', type: 'address' },\n      { name: 'spender', type: 'address' },\n      { name: 'value', type: 'uint256' },\n      { name: 'nonce', type: 'uint256' },\n      { name: 'deadline', type: 'uint256' }\n    ]\n    const message = {\n      owner: account,\n      spender: stakingInfo.stakingRewardAddress,\n      value: liquidityAmount.raw.toString(),\n      nonce: nonce.toHexString(),\n      deadline: deadline.toNumber()\n    }\n    const data = JSON.stringify({\n      types: {\n        EIP712Domain,\n        Permit\n      },\n      domain,\n      primaryType: 'Permit',\n      message\n    })\n\n    library\n      .send('eth_signTypedData_v4', [account, data])\n      .then(splitSignature)\n      .then(signature => {\n        setSignatureData({\n          v: signature.v,\n          r: signature.r,\n          s: signature.s,\n          deadline: deadline.toNumber()\n        })\n      })\n      .catch(error => {\n        // for all errors other than 4001 (EIP-1193 user rejected request), fall back to manual approve\n        if (error?.code !== 4001) {\n          approveCallback()\n        }\n      })\n  }\n\n  return (\n    <Modal isOpen={isOpen} onDismiss={wrappedOnDismiss} maxHeight={90}>\n      {!attempting && !hash && (\n        <ContentWrapper gap=\"lg\">\n          <RowBetween>\n            <TYPE.mediumHeader>Deposit</TYPE.mediumHeader>\n            <CloseIcon onClick={wrappedOnDismiss} />\n          </RowBetween>\n          <CurrencyInputPanel\n            value={typedValue}\n            onUserInput={onUserInput}\n            onMax={handleMax}\n            showMaxButton={!atMaxAmount}\n            currency={stakingInfo.stakedAmount.token}\n            pair={dummyPair}\n            label={''}\n            disableCurrencySelect={true}\n            customBalanceText={'Available to deposit: '}\n            id=\"stake-liquidity-token\"\n          />\n\n          <HypotheticalRewardRate dim={!hypotheticalRewardRate.greaterThan('0')}>\n            <div>\n              <TYPE.black fontWeight={600}>Weekly Rewards</TYPE.black>\n            </div>\n\n            <TYPE.black>\n              {hypotheticalRewardRate.multiply((60 * 60 * 24 * 7).toString()).toSignificant(4, { groupSeparator: ',' })}{' '}\n              UNI / week\n            </TYPE.black>\n          </HypotheticalRewardRate>\n\n          <RowBetween>\n            <ButtonConfirmed\n              mr=\"0.5rem\"\n              onClick={onAttemptToApprove}\n              confirmed={approval === ApprovalState.APPROVED || signatureData !== null}\n              disabled={approval !== ApprovalState.NOT_APPROVED || signatureData !== null}\n            >\n              Approve\n            </ButtonConfirmed>\n            <ButtonError\n              disabled={!!error || (signatureData === null && approval !== ApprovalState.APPROVED)}\n              error={!!error && !!parsedAmount}\n              onClick={onStake}\n            >\n              {error ?? 'Deposit'}\n            </ButtonError>\n          </RowBetween>\n          <ProgressCircles steps={[approval === ApprovalState.APPROVED || signatureData !== null]} disabled={true} />\n        </ContentWrapper>\n      )}\n      {attempting && !hash && (\n        <LoadingView onDismiss={wrappedOnDismiss}>\n          <AutoColumn gap=\"12px\" justify={'center'}>\n            <TYPE.largeHeader>Depositing Liquidity</TYPE.largeHeader>\n            <TYPE.body fontSize={20}>{parsedAmount?.toSignificant(4)} UNI-V2</TYPE.body>\n          </AutoColumn>\n        </LoadingView>\n      )}\n      {attempting && hash && (\n        <SubmittedView onDismiss={wrappedOnDismiss} hash={hash}>\n          <AutoColumn gap=\"12px\" justify={'center'}>\n            <TYPE.largeHeader>Transaction Submitted</TYPE.largeHeader>\n            <TYPE.body fontSize={20}>Deposited {parsedAmount?.toSignificant(4)} UNI-V2</TYPE.body>\n          </AutoColumn>\n        </SubmittedView>\n      )}\n    </Modal>\n  )\n}\n"]},"metadata":{},"sourceType":"module"}